<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Container App (POC)</title>
</head>
<body>
  <h1>📝 Multi-Container App (POC)</h1>

  <!-- Section: Notes via Queue -->
  <form id="noteForm">
    <input type="text" id="title" placeholder="Title" required />
    <input type="text" id="content" placeholder="Content" required />
    <button type="submit">💾 Save</button>
  </form>

  <ul id="notesList"></ul>

  <hr>

  <!-- Section: Submit to Queue (via API Gateway) -->
  <h2>📤 Send to RabbitMQ via Gateway</h2>
  <form id="queueForm">
    <input type="text" id="queueTitle" placeholder="Title" required />
    <input id="queueContent" placeholder="Content" required />
    <button type="submit">🚀 Send to Queue</button>
  </form>

  <script>
    // 🌐 ALB HTTPS URL (replace with actual 443 port URL from Codespaces)
    const BASE_URL = 'https://vigilant-space-guide-v65wvgjx5ppqcxxr-443.app.github.dev';

    // 🔁 Fetch notes from backend DB
    async function fetchNotes() {
      const resultElement = document.getElementById('notesList');
      resultElement.innerHTML = '';

      try {
        const res = await fetch(`${BASE_URL}/api/notes`);
        const data = await res.json();

        data.forEach(note => {
          const item = document.createElement('li');
          item.innerHTML = `
            <strong>${note.title}</strong>: ${note.content}
            <button onclick="editNote(${note.id}, '${note.title}', '${note.content}')">✏️ Edit</button>
            <button onclick="deleteNote(${note.id})">🗑 Delete</button>
          `;
          resultElement.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        resultElement.innerText = '❌ Error loading notes.';
      }
    }

    // ✏️ Edit behavior (UI only)
    function editNote(id, title, content) {
      document.getElementById('title').value = title;
      document.getElementById('content').value = content;
    }

    // 📨 Submit to RabbitMQ via API Gateway through ALB
    document.getElementById('noteForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;

      try {
        await fetch(`${BASE_URL}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content })
        });

        alert('✅ Sent to queue!');
        this.reset();
        // Optional: fetchNotes(); // Only fetch when DB is eventually updated
      } catch (err) {
        console.error(err);
        alert('❌ Failed to send');
      }
    });

    // 🗑 Delete from DB
    async function deleteNote(id) {
      try {
        await fetch(`${BASE_URL}/api/notes/${id}`, {
          method: 'DELETE'
        });
        fetchNotes();
      } catch (err) {
        console.error('❌ Failed to delete:', err);
      }
    }

    // 🧪 Debug Queue Submit via ALB (Optional form)
    document.getElementById('queueForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('queueTitle').value;
      const content = document.getElementById('queueContent').value;

      try {
        const response = await fetch(`${BASE_URL}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content })
        });

        const result = await response.text();
        alert('📨 Sent to queue: ' + result);
      } catch (err) {
        console.error('❌ Error sending to queue:', err);
        alert('❌ Failed to send to queue.');
      }

      this.reset();
    });

    // 🏁 Initial load
    fetchNotes();
  </script>
</body>
</html>
